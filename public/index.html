<!DOCTYPE html>

<head>
  <!-- chessjs requires jquery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"
    integrity="sha512-xRllwz2gdZciIB+AkEbeq+gVhX8VB8XsfqeFbUh+SzHlN96dEduwtTuVuc2u9EROlmW9+yhRlxjif66ORpsgVA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- chessboardjs -->
  <link rel="stylesheet" href="chessboardjs/css/chessboard-1.0.0.min.css">
  <script src="chessboardjs/js/chessboard-1.0.0.min.js"></script>

  <link rel="stylesheet" href="style.css">
</head>

<style type="text/css">
  .highlight-white {
    box-shadow: inset 0 0 3px 3px yellow;
  }

  .highlight-black {
    box-shadow: inset 0 0 3px 3px blue;
  }
</style>

<body>
  <h1 id="title">JS Project - Multiplayer Chess Server</h1>
  <p id="groupname">by William Dann and Claudia Souza</p>
  
  <br>
  
  <div id="info_panel">
    <h3>User Info</h3>
    <label>Set Name: </label>
    <input id="name_input">
    <button onclick="player_name=document.querySelector('#name_input').value">Set Name</button>

    <br>
    <h3>Join a Game</h3>


    <form id="info_form" name = "getName">
      <label for = "join_code"> GameID: </label>
      <input type = "text" name = "JoinCode" id = "join_code">
      <input type = "submit" value = "Send">
      </form>
      <br>

      <h3>Create a Game</h3>
      <button onclick="handleNewGame(true)">New Game as White</button>
      <button onclick="handleNewGame(false)">New Game as Black</button>

      <br>

    </div>

    <h4>GameID: </h4><h4 id="game_id"></h4>
    
    <script>
        // handle join game form submission
        document.querySelector("form").addEventListener('submit', event => {
          event.preventDefault(); // prevent page from doing usual redirects and stuff

          gameID = event.target.querySelector('#join_code').value;

          if (!player_name) 
            return alert ("Please enter a name first.");
          if (gameID == "")
            return alert ("Please enter the code of a game you wish to join.");

          console.log("Loaded:");
          console.log(player_name);
          console.log(gameID);
          console.log('---');

          joinGame();

          const info = document.querySelector("#info_panel");
          info.parentElement.removeChild(info);
        });

        async function joinGame() {
          const response = await fetchPosition();
          if (!response.whitePlayer) {
            return setPlayers(player_name)
          }
          if (!response.blackPlayer) {
            return setPlayers(null, black=player_name)
          }

          alert('No free space to join game!');
        }

        async function createNewGame(whitePlayer=true) {
          const response = await fetch('/game', {
            method: 'POST',
            cors: 'cors',
            cache: 'no-cache',
            credentials: 'same-origin',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            redirect: 'follow',
            referrerPolicy: 'no-referrer',
            body: whitePlayer ? 'whitePlayer='+player_name : 'blackPlayer='+player_name // if white player then set whitePlayer to current user else set black player
          });

          const data = await response.json();
          return data.id;
        }

        async function handleNewGame(asWhite=true) {
          if (!player_name) 
            return alert("Please enter a name first");

          // send request to create new game
          const newid = await createNewGame();

          gameID = newid;
          console.log("Game created: " + newid);
          updateStatus()

          const info = document.querySelector("#info_panel");
          info.parentElement.removeChild(info);
        }

    </script>

  <div id="boardChess"> </div>

    <div id="blackPlayer"></div>
      <div id="myBoard" style="width: 400px"></div>
      <div id="whitePlayer"></div><br>

    <label>Status:</label>
    <div id="status"></div>
    <label>FEN:</label>
    <div id="fen"></div>
    <label>PGN:</label>
    <div id="pgn"></div>

    <script src="chess.js"></script>
  </div>
</body>